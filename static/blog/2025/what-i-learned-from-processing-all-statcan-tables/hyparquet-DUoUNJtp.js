const F=["BOOLEAN","INT32","INT64","INT96","FLOAT","DOUBLE","BYTE_ARRAY","FIXED_LEN_BYTE_ARRAY"],T=["PLAIN","GROUP_VAR_INT","PLAIN_DICTIONARY","RLE","BIT_PACKED","DELTA_BINARY_PACKED","DELTA_LENGTH_BYTE_ARRAY","DELTA_BYTE_ARRAY","RLE_DICTIONARY","BYTE_STREAM_SPLIT"],se=["REQUIRED","OPTIONAL","REPEATED"],le=["UTF8","MAP","MAP_KEY_VALUE","LIST","ENUM","DECIMAL","DATE","TIME_MILLIS","TIME_MICROS","TIMESTAMP_MILLIS","TIMESTAMP_MICROS","UINT_8","UINT_16","UINT_32","UINT_64","INT_8","INT_16","INT_32","INT_64","JSON","BSON","INTERVAL"],ce=["UNCOMPRESSED","SNAPPY","GZIP","LZO","BROTLI","LZ4","ZSTD","LZ4_RAW"],z=["DATA_PAGE","INDEX_PAGE","DICTIONARY_PAGE","DATA_PAGE_V2"],j={timestampFromMilliseconds(e){return new Date(Number(e))},timestampFromMicroseconds(e){return new Date(Number(e/1000n))},timestampFromNanoseconds(e){return new Date(Number(e/1000000n))},dateFromDays(e){return new Date(e*864e5)}};function C(e,t,n,f){if(t&&n.endsWith("_DICTIONARY")){let i=e;e instanceof Uint8Array&&!(t instanceof Uint8Array)&&(i=new t.constructor(e.length));for(let r=0;r<e.length;r++)i[r]=t[e[r]];return i}else return G(e,f)}function G(e,t){const{element:n,parsers:f,utf8:i=!0}=t,{type:r,converted_type:o,logical_type:s}=n;if(o==="DECIMAL"){const a=10**-(n.scale||0),l=new Array(e.length);for(let u=0;u<l.length;u++)e[0]instanceof Uint8Array?l[u]=W(e[u])*a:l[u]=Number(e[u])*a;return l}if(!o&&r==="INT96"){const c=new Array(e.length);for(let a=0;a<c.length;a++)c[a]=f.timestampFromNanoseconds(ae(e[a]));return c}if(o==="DATE"){const c=new Array(e.length);for(let a=0;a<c.length;a++)c[a]=f.dateFromDays(e[a]);return c}if(o==="TIMESTAMP_MILLIS"){const c=new Array(e.length);for(let a=0;a<c.length;a++)c[a]=f.timestampFromMilliseconds(e[a]);return c}if(o==="TIMESTAMP_MICROS"){const c=new Array(e.length);for(let a=0;a<c.length;a++)c[a]=f.timestampFromMicroseconds(e[a]);return c}if(o==="JSON"){const c=new TextDecoder;return e.map(a=>JSON.parse(c.decode(a)))}if(o==="BSON")throw new Error("parquet bson not supported");if(o==="INTERVAL")throw new Error("parquet interval not supported");if(o==="UTF8"||s?.type==="STRING"||i&&r==="BYTE_ARRAY"){const c=new TextDecoder,a=new Array(e.length);for(let l=0;l<a.length;l++)a[l]=e[l]&&c.decode(e[l]);return a}if(o==="UINT_64"||s?.type==="INTEGER"&&s.bitWidth===64&&!s.isSigned){if(e instanceof BigInt64Array)return new BigUint64Array(e.buffer,e.byteOffset,e.length);const c=new BigUint64Array(e.length);for(let a=0;a<c.length;a++)c[a]=BigInt(e[a]);return c}if(o==="UINT_32"||s?.type==="INTEGER"&&s.bitWidth===32&&!s.isSigned){if(e instanceof Int32Array)return new Uint32Array(e.buffer,e.byteOffset,e.length);const c=new Uint32Array(e.length);for(let a=0;a<c.length;a++)c[a]=e[a];return c}if(s?.type==="FLOAT16")return Array.from(e).map(Z);if(s?.type==="TIMESTAMP"){const{unit:c}=s;let a=f.timestampFromMilliseconds;c==="MICROS"&&(a=f.timestampFromMicroseconds),c==="NANOS"&&(a=f.timestampFromNanoseconds);const l=new Array(e.length);for(let u=0;u<l.length;u++)l[u]=a(e[u]);return l}return e}function W(e){let t=0;for(const f of e)t=t*256+f;const n=e.length*8;return t>=2**(n-1)&&(t-=2**n),t}function ae(e){const t=(e>>64n)-2440588n,n=e&0xffffffffffffffffn;return t*86400000000000n+n}function Z(e){if(!e)return;const t=e[1]<<8|e[0],n=t>>15?-1:1,f=t>>10&31,i=t&1023;return f===0?n*2**-14*(i/1024):f===31?i?NaN:n*(1/0):n*2**(f-15)*(1+i/1024)}function Q(e,t,n){const f=e[t],i=[];let r=1;if(f.num_children)for(;i.length<f.num_children;){const o=e[t+r],s=Q(e,t+r,[...n,o.name]);r+=s.count,i.push(s)}return{count:r,element:f,children:i,path:n}}function H(e,t){let n=Q(e,0,[]);const f=[n];for(const i of t){const r=n.children.find(o=>o.element.name===i);if(!r)throw new Error(`parquet schema element not found: ${t}`);f.push(r),n=r}return f}function K(e){let t=0;for(const{element:n}of e)n.repetition_type==="REPEATED"&&t++;return t}function U(e){let t=0;for(const{element:n}of e.slice(1))n.repetition_type!=="REQUIRED"&&t++;return t}function ue(e){if(!e||e.element.converted_type!=="LIST"||e.children.length>1)return!1;const t=e.children[0];return!(t.children.length>1||t.element.repetition_type!=="REPEATED")}function _e(e){if(!e||e.element.converted_type!=="MAP"||e.children.length>1)return!1;const t=e.children[0];return!(t.children.length!==2||t.element.repetition_type!=="REPEATED"||t.children.find(i=>i.element.name==="key")?.element.repetition_type==="REPEATED"||t.children.find(i=>i.element.name==="value")?.element.repetition_type==="REPEATED")}function de(e){if(e.length!==2)return!1;const[,t]=e;return!(t.element.repetition_type==="REPEATED"||t.children.length)}const m={STOP:0,TRUE:1,FALSE:2,BYTE:3,I16:4,I32:5,I64:6,DOUBLE:7,BINARY:8,LIST:9,STRUCT:12};function X(e){let t=0;const n={};for(;e.offset<e.view.byteLength;){const[f,i,r]=ee(e,t);if(t=r,f===m.STOP)break;n[`field_${i}`]=N(e,f)}return n}function N(e,t){switch(t){case m.TRUE:return!0;case m.FALSE:return!1;case m.BYTE:return e.view.getInt8(e.offset++);case m.I16:case m.I32:return we(e);case m.I64:return S(e);case m.DOUBLE:{const n=e.view.getFloat64(e.offset,!0);return e.offset+=8,n}case m.BINARY:{const n=v(e),f=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,n);return e.offset+=n,f}case m.LIST:{const[n,f]=ge(e),i=n===m.TRUE||n===m.FALSE,r=new Array(f);for(let o=0;o<f;o++)r[o]=i?N(e,m.BYTE)===1:N(e,n);return r}case m.STRUCT:{const n={};let f=0;for(;;){let i,r;if([i,r,f]=ee(e,f),i===m.STOP)break;n[`field_${r}`]=N(e,i)}return n}default:throw new Error(`thrift unhandled type: ${t}`)}}function v(e){let t=0,n=0;for(;;){const f=e.view.getUint8(e.offset++);if(t|=(f&127)<<n,!(f&128))return t;n+=7}}function he(e){let t=0n,n=0n;for(;;){const f=e.view.getUint8(e.offset++);if(t|=BigInt(f&127)<<n,!(f&128))return t;n+=7n}}function we(e){const t=v(e);return t>>>1^-(t&1)}function S(e){const t=he(e);return t>>1n^-(t&1n)}function J(e){return e&15}function ee(e,t){const n=e.view.getUint8(e.offset++);if((n&15)===m.STOP)return[0,0,t];const f=n>>4;let i;if(f)i=t+f;else throw new Error("non-delta field id not supported");return[J(n),i,i]}function ge(e){const t=e.view.getUint8(e.offset++),n=t>>4,f=J(t);if(n===15){const i=v(e);return[f,i]}return[f,n]}const pe=1<<19;async function ye(e,{parsers:t,initialFetchSize:n=pe}={}){if(!e||!(e.byteLength>=0))throw new Error("parquet expected AsyncBuffer");const f=Math.max(0,e.byteLength-n),i=await e.slice(f,e.byteLength),r=new DataView(i);if(r.getUint32(i.byteLength-4,!0)!==827474256)throw new Error("parquet file invalid (footer != PAR1)");const o=r.getUint32(i.byteLength-8,!0);if(o>e.byteLength-8)throw new Error(`parquet metadata length ${o} exceeds available buffer ${e.byteLength-8}`);if(o+8>n){const s=e.byteLength-o-8,c=await e.slice(s,f),a=new ArrayBuffer(o+8),l=new Uint8Array(a);return l.set(new Uint8Array(c)),l.set(new Uint8Array(i),f-s),q(a,{parsers:t})}else return q(i,{parsers:t})}function q(e,{parsers:t}={}){if(!(e instanceof ArrayBuffer))throw new Error("parquet expected ArrayBuffer");const n=new DataView(e);if(t={...j,...t},n.byteLength<8)throw new Error("parquet file is too short");if(n.getUint32(n.byteLength-4,!0)!==827474256)throw new Error("parquet file invalid (footer != PAR1)");const f=n.byteLength-8,i=n.getUint32(f,!0);if(i>n.byteLength-8)throw new Error(`parquet metadata length ${i} exceeds available buffer ${n.byteLength-8}`);const r=f-i,s=X({view:n,offset:r}),c=new TextDecoder;function a(d){return d&&c.decode(d)}const l=s.field_1,u=s.field_2.map(d=>({type:F[d.field_1],type_length:d.field_2,repetition_type:se[d.field_3],name:a(d.field_4),num_children:d.field_5,converted_type:le[d.field_6],scale:d.field_7,precision:d.field_8,field_id:d.field_9,logical_type:Ae(d.field_10)})),_=u.filter(d=>d.type),g=s.field_3,w=s.field_4.map(d=>({columns:d.field_1.map((h,A)=>({file_path:a(h.field_1),file_offset:h.field_2,meta_data:h.field_3&&{type:F[h.field_3.field_1],encodings:h.field_3.field_2?.map(I=>T[I]),path_in_schema:h.field_3.field_3.map(a),codec:ce[h.field_3.field_4],num_values:h.field_3.field_5,total_uncompressed_size:h.field_3.field_6,total_compressed_size:h.field_3.field_7,key_value_metadata:h.field_3.field_8,data_page_offset:h.field_3.field_9,index_page_offset:h.field_3.field_10,dictionary_page_offset:h.field_3.field_11,statistics:Ee(h.field_3.field_12,_[A],t),encoding_stats:h.field_3.field_13?.map(I=>({page_type:z[I.field_1],encoding:T[I.field_2],count:I.field_3})),bloom_filter_offset:h.field_3.field_14,bloom_filter_length:h.field_3.field_15,size_statistics:h.field_3.field_16&&{unencoded_byte_array_data_bytes:h.field_3.field_16.field_1,repetition_level_histogram:h.field_3.field_16.field_2,definition_level_histogram:h.field_3.field_16.field_3}},offset_index_offset:h.field_4,offset_index_length:h.field_5,column_index_offset:h.field_6,column_index_length:h.field_7,crypto_metadata:h.field_8,encrypted_column_metadata:h.field_9})),total_byte_size:d.field_2,num_rows:d.field_3,sorting_columns:d.field_4?.map(h=>({column_idx:h.field_1,descending:h.field_2,nulls_first:h.field_3})),file_offset:d.field_5,total_compressed_size:d.field_6,ordinal:d.field_7})),p=s.field_5?.map(d=>({key:a(d.field_1),value:a(d.field_2)})),y=a(s.field_6);return{version:l,schema:u,num_rows:g,row_groups:w,key_value_metadata:p,created_by:y,metadata_length:i}}function me({schema:e}){return H(e,[])[0]}function Ae(e){return e?.field_1?{type:"STRING"}:e?.field_2?{type:"MAP"}:e?.field_3?{type:"LIST"}:e?.field_4?{type:"ENUM"}:e?.field_5?{type:"DECIMAL",scale:e.field_5.field_1,precision:e.field_5.field_2}:e?.field_6?{type:"DATE"}:e?.field_7?{type:"TIME",isAdjustedToUTC:e.field_7.field_1,unit:Y(e.field_7.field_2)}:e?.field_8?{type:"TIMESTAMP",isAdjustedToUTC:e.field_8.field_1,unit:Y(e.field_8.field_2)}:e?.field_10?{type:"INTEGER",bitWidth:e.field_10.field_1,isSigned:e.field_10.field_2}:e?.field_11?{type:"NULL"}:e?.field_12?{type:"JSON"}:e?.field_13?{type:"BSON"}:e?.field_14?{type:"UUID"}:e?.field_15?{type:"FLOAT16"}:e}function Y(e){if(e.field_1)return"MILLIS";if(e.field_2)return"MICROS";if(e.field_3)return"NANOS";throw new Error("parquet time unit required")}function Ee(e,t,n){return e&&{max:R(e.field_1,t,n),min:R(e.field_2,t,n),null_count:e.field_3,distinct_count:e.field_4,max_value:R(e.field_5,t,n),min_value:R(e.field_6,t,n),is_max_value_exact:e.field_7,is_min_value_exact:e.field_8}}function R(e,t,n){const{type:f,converted_type:i,logical_type:r}=t;if(e===void 0)return e;if(f==="BOOLEAN")return e[0]===1;if(f==="BYTE_ARRAY")return new TextDecoder().decode(e);const o=new DataView(e.buffer,e.byteOffset,e.byteLength);return f==="FLOAT"&&o.byteLength===4?o.getFloat32(0,!0):f==="DOUBLE"&&o.byteLength===8?o.getFloat64(0,!0):f==="INT32"&&i==="DATE"?n.dateFromDays(o.getInt32(0,!0)):f==="INT64"&&i==="TIMESTAMP_MILLIS"?n.timestampFromMilliseconds(o.getBigInt64(0,!0)):f==="INT64"&&i==="TIMESTAMP_MICROS"?n.timestampFromMicroseconds(o.getBigInt64(0,!0)):f==="INT64"&&r?.type==="TIMESTAMP"&&r?.unit==="NANOS"?n.timestampFromNanoseconds(o.getBigInt64(0,!0)):f==="INT64"&&r?.type==="TIMESTAMP"&&r?.unit==="MICROS"?n.timestampFromMicroseconds(o.getBigInt64(0,!0)):f==="INT64"&&r?.type==="TIMESTAMP"?n.timestampFromMilliseconds(o.getBigInt64(0,!0)):f==="INT32"&&o.byteLength===4?o.getInt32(0,!0):f==="INT64"&&o.byteLength===8?o.getBigInt64(0,!0):i==="DECIMAL"?W(e)*10**-(t.scale||0):r?.type==="FLOAT16"?Z(e):e}function M(e,t){for(let f=0;f<t.length;f+=1e4)e.push(...t.slice(f,f+1e4))}async function Ie(e,t,n){return await(n??globalThis.fetch)(e,{...t,method:"HEAD"}).then(i=>{if(!i.ok)throw new Error(`fetch head failed ${i.status}`);const r=i.headers.get("Content-Length");if(!r)throw new Error("missing content length");return parseInt(r)})}async function Je({url:e,byteLength:t,requestInit:n,fetch:f}){if(!e)throw new Error("missing url");const i=f??globalThis.fetch;t||=await Ie(e,n,i);let r;const o=n||{};return{byteLength:t,async slice(s,c){if(r)return r.then(_=>_.slice(s,c));const a=new Headers(o.headers),l=c===void 0?"":c-1;a.set("Range",`bytes=${s}-${l}`);const u=await i(e,{...o,headers:a});if(!u.ok||!u.body)throw new Error(`fetch failed ${u.status}`);if(u.status===200)return r=u.arrayBuffer(),r.then(_=>_.slice(s,c));if(u.status===206)return u.arrayBuffer();throw new Error(`fetch received unexpected status code ${u.status}`)}}}function te(e){if(!e)return[];if(e.length===1)return e[0];const t=[];for(const n of e)M(t,n);return t}const Te=1<<25;function ve({metadata:e,rowStart:t=0,rowEnd:n=1/0,columns:f}){if(!e)throw new Error("parquetPlan requires metadata");const i=[],r=[];let o=0;for(const s of e.row_groups){const c=Number(s.num_rows),a=o+c;if(c>0&&a>=t&&o<n){const l=[];for(const{file_path:w,meta_data:p}of s.columns){if(w)throw new Error("parquet file_path not supported");if(!p)throw new Error("parquet column metadata is undefined");(!f||f.includes(p.path_in_schema[0]))&&l.push(ne(p))}const u=Math.max(t-o,0),_=Math.min(n-o,c);i.push({ranges:l,rowGroup:s,groupStart:o,groupRows:c,selectStart:u,selectEnd:_});const g=l[l.length-1]?.endByte-l[0]?.startByte;if(!f&&g<Te)r.push({startByte:l[0].startByte,endByte:l[l.length-1].endByte});else if(l.length)M(r,l);else if(f?.length)throw new Error(`parquet columns not found: ${f.join(", ")}`)}o=a}return isFinite(n)||(n=o),{metadata:e,rowStart:t,rowEnd:n,columns:f,fetches:r,groups:i}}function ne({dictionary_page_offset:e,data_page_offset:t,total_compressed_size:n}){const f=e||t;return{startByte:Number(f),endByte:Number(f+n)}}function be(e,{fetches:t}){const n=t.map(({startByte:f,endByte:i})=>e.slice(f,i));return{byteLength:e.byteLength,slice(f,i=e.byteLength){const r=t.findIndex(({startByte:o,endByte:s})=>o<=f&&i<=s);if(r<0)throw new Error(`no prefetch for range [${f}, ${i}]`);if(t[r].startByte!==f||t[r].endByte!==i){const o=f-t[r].startByte,s=i-t[r].startByte;return n[r]instanceof Promise?n[r].then(c=>c.slice(o,s)):n[r].slice(o,s)}else return n[r]}}}function k(e,t,n,f,i){const r=t?.length||n.length;if(!r)return f;const o=U(i),s=i.map(({element:w})=>w.repetition_type);let c=0;const a=[e];let l=e,u=0,_=0,g=0;if(n[0])for(;u<s.length-2&&g<n[0];)u++,s[u]!=="REQUIRED"&&(l=l.at(-1),a.push(l),_++),s[u]==="REPEATED"&&g++;for(let w=0;w<r;w++){const p=t?.length?t[w]:o,y=n[w];for(;u&&(y<g||s[u]!=="REPEATED");)s[u]!=="REQUIRED"&&(a.pop(),_--),s[u]==="REPEATED"&&g--,u--;for(l=a.at(-1);(u<s.length-2||s[u+1]==="REPEATED")&&(_<p||s[u+1]==="REQUIRED");){if(u++,s[u]!=="REQUIRED"){const d=[];l.push(d),l=d,a.push(d),_++}s[u]==="REPEATED"&&g++}p===o?l.push(f[c++]):u===s.length-2?l.push(null):l.push([])}if(!e.length)for(let w=0;w<o;w++){const p=[];l.push(p),l=p}return e}function b(e,t,n=0){const f=t.path.join("."),i=t.element.repetition_type==="OPTIONAL",r=i?n+1:n;if(ue(t)){let o=t.children[0],s=r;o.children.length===1&&(o=o.children[0],s++),b(e,o,s);const c=o.path.join("."),a=e.get(c);if(!a)throw new Error("parquet list column missing values");i&&O(a,n),e.set(f,a),e.delete(c);return}if(_e(t)){const o=t.children[0].element.name;b(e,t.children[0].children[0],r+1),b(e,t.children[0].children[1],r+1);const s=e.get(`${f}.${o}.key`),c=e.get(`${f}.${o}.value`);if(!s)throw new Error("parquet map column missing keys");if(!c)throw new Error("parquet map column missing values");if(s.length!==c.length)throw new Error("parquet map column key/value length mismatch");const a=ie(s,c,r);i&&O(a,n),e.delete(`${f}.${o}.key`),e.delete(`${f}.${o}.value`),e.set(f,a);return}if(t.children.length){const o=t.element.repetition_type==="REQUIRED"?n:n+1,s={};for(const a of t.children){b(e,a,o);const l=e.get(a.path.join("."));if(!l)throw new Error("parquet struct missing child data");s[a.element.name]=l}for(const a of t.children)e.delete(a.path.join("."));const c=fe(s,o);i&&O(c,n),e.set(f,c)}}function O(e,t){for(let n=0;n<e.length;n++)t?O(e[n],t-1):e[n]=e[n][0]}function ie(e,t,n){const f=[];for(let i=0;i<e.length;i++)if(n)f.push(ie(e[i],t[i],n-1));else if(e[i]){const r={};for(let o=0;o<e[i].length;o++){const s=t[i][o];r[e[i][o]]=s===void 0?null:s}f.push(r)}else f.push(void 0);return f}function fe(e,t){const n=Object.keys(e),f=e[n[0]]?.length,i=[];for(let r=0;r<f;r++){const o={};for(const s of n){if(e[s].length!==f)throw new Error("parquet struct parsing error");o[s]=e[s][r]}t?i.push(fe(o,t-1)):i.push(o)}return i}function L(e,t,n){const f=n instanceof Int32Array,i=v(e),r=v(e);v(e);let o=S(e),s=0;n[s++]=f?Number(o):o;const c=i/r;for(;s<t;){const a=S(e),l=new Uint8Array(r);for(let u=0;u<r;u++)l[u]=e.view.getUint8(e.offset++);for(let u=0;u<r&&s<t;u++){const _=BigInt(l[u]);if(_){let g=0n,w=c;const p=(1n<<_)-1n;for(;w&&s<t;){let y=BigInt(e.view.getUint8(e.offset))>>g&p;for(g+=_;g>=8;)g-=8n,e.offset++,g&&(y|=BigInt(e.view.getUint8(e.offset))<<_-g&p);const d=a+y;o+=d,n[s++]=f?Number(o):o,w--}w&&(e.offset+=Math.ceil((w*Number(_)+Number(g))/8))}else for(let g=0;g<c&&s<t;g++)o+=a,n[s++]=f?Number(o):o}}}function re(e,t,n){const f=new Int32Array(t);L(e,t,f);for(let i=0;i<t;i++)n[i]=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,f[i]),e.offset+=f[i]}function Le(e,t,n){const f=new Int32Array(t);L(e,t,f);const i=new Int32Array(t);L(e,t,i);for(let r=0;r<t;r++){const o=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,i[r]);f[r]?(n[r]=new Uint8Array(f[r]+i[r]),n[r].set(n[r-1].subarray(0,f[r])),n[r].set(o,f[r])):n[r]=o,e.offset+=i[r]}}function D(e){return 32-Math.clz32(e)}function E(e,t,n,f){f===void 0&&(f=e.view.getUint32(e.offset,!0),e.offset+=4);const i=e.offset;let r=0;for(;r<n.length;){const o=v(e);if(o&1)r=Ne(e,o,t,n,r);else{const s=o>>>1;Re(e,s,t,n,r),r+=s}}e.offset=i+f}function Re(e,t,n,f,i){const r=n+7>>3;let o=0;for(let s=0;s<r;s++)o|=e.view.getUint8(e.offset++)<<(s<<3);for(let s=0;s<t;s++)f[i+s]=o}function Ne(e,t,n,f,i){let r=t>>1<<3;const o=(1<<n)-1;let s=0;if(e.offset<e.view.byteLength)s=e.view.getUint8(e.offset++);else if(o)throw new Error(`parquet bitpack offset ${e.offset} out of range`);let c=8,a=0;for(;r;)a>8?(a-=8,c-=8,s>>>=8):c-a<n?(s|=e.view.getUint8(e.offset)<<c,e.offset++,c+=8):(i<f.length&&(f[i++]=s>>a&o),r--,a+=n);return i}function oe(e,t,n,f){const i=Oe(n,f),r=new Uint8Array(t*i);for(let o=0;o<i;o++)for(let s=0;s<t;s++)r[s*i+o]=e.view.getUint8(e.offset++);if(n==="FLOAT")return new Float32Array(r.buffer);if(n==="DOUBLE")return new Float64Array(r.buffer);if(n==="INT32")return new Int32Array(r.buffer);if(n==="INT64")return new BigInt64Array(r.buffer);if(n==="FIXED_LEN_BYTE_ARRAY"){const o=new Array(t);for(let s=0;s<t;s++)o[s]=r.subarray(s*i,(s+1)*i);return o}throw new Error(`parquet byte_stream_split unsupported type: ${n}`)}function Oe(e,t){switch(e){case"INT32":case"FLOAT":return 4;case"INT64":case"DOUBLE":return 8;case"FIXED_LEN_BYTE_ARRAY":if(!t)throw new Error("parquet byteWidth missing type_length");return t;default:throw new Error(`parquet unsupported type: ${e}`)}}function x(e,t,n,f){if(n===0)return[];if(t==="BOOLEAN")return De(e,n);if(t==="INT32")return Pe(e,n);if(t==="INT64")return Se(e,n);if(t==="INT96")return Be(e,n);if(t==="FLOAT")return Ue(e,n);if(t==="DOUBLE")return Me(e,n);if(t==="BYTE_ARRAY")return xe(e,n);if(t==="FIXED_LEN_BYTE_ARRAY"){if(!f)throw new Error("parquet missing fixed length");return Fe(e,n,f)}else throw new Error(`parquet unhandled type: ${t}`)}function De(e,t){const n=new Array(t);for(let f=0;f<t;f++){const i=e.offset+(f/8|0),r=f%8,o=e.view.getUint8(i);n[f]=(o&1<<r)!==0}return e.offset+=Math.ceil(t/8),n}function Pe(e,t){const n=(e.view.byteOffset+e.offset)%4?new Int32Array(P(e.view.buffer,e.view.byteOffset+e.offset,t*4)):new Int32Array(e.view.buffer,e.view.byteOffset+e.offset,t);return e.offset+=t*4,n}function Se(e,t){const n=(e.view.byteOffset+e.offset)%8?new BigInt64Array(P(e.view.buffer,e.view.byteOffset+e.offset,t*8)):new BigInt64Array(e.view.buffer,e.view.byteOffset+e.offset,t);return e.offset+=t*8,n}function Be(e,t){const n=new Array(t);for(let f=0;f<t;f++){const i=e.view.getBigInt64(e.offset+f*12,!0),r=e.view.getInt32(e.offset+f*12+8,!0);n[f]=BigInt(r)<<64n|i}return e.offset+=t*12,n}function Ue(e,t){const n=(e.view.byteOffset+e.offset)%4?new Float32Array(P(e.view.buffer,e.view.byteOffset+e.offset,t*4)):new Float32Array(e.view.buffer,e.view.byteOffset+e.offset,t);return e.offset+=t*4,n}function Me(e,t){const n=(e.view.byteOffset+e.offset)%8?new Float64Array(P(e.view.buffer,e.view.byteOffset+e.offset,t*8)):new Float64Array(e.view.buffer,e.view.byteOffset+e.offset,t);return e.offset+=t*8,n}function xe(e,t){const n=new Array(t);for(let f=0;f<t;f++){const i=e.view.getUint32(e.offset,!0);e.offset+=4,n[f]=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,i),e.offset+=i}return n}function Fe(e,t,n){const f=new Array(t);for(let i=0;i<t;i++)f[i]=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,n),e.offset+=n;return f}function P(e,t,n){const f=new ArrayBuffer(n);return new Uint8Array(f).set(new Uint8Array(e,t,n)),f}const Ce=[0,255,65535,16777215,4294967295];function $(e,t,n,f,i){for(let r=0;r<i;r++)n[f+r]=e[t+r]}function qe(e,t){const n=e.byteLength,f=t.byteLength;let i=0,r=0;for(;i<n;){const o=e[i];if(i++,o<128)break}if(f&&i>=n)throw new Error("invalid snappy length header");for(;i<n;){const o=e[i];let s=0;if(i++,i>=n)throw new Error("missing eof marker");if((o&3)===0){let c=(o>>>2)+1;if(c>60){if(i+3>=n)throw new Error("snappy error literal pos + 3 >= inputLength");const a=c-60;c=e[i]+(e[i+1]<<8)+(e[i+2]<<16)+(e[i+3]<<24),c=(c&Ce[a])+1,i+=a}if(i+c>n)throw new Error("snappy error literal exceeds input length");$(e,i,t,r,c),i+=c,r+=c}else{let c=0;switch(o&3){case 1:s=(o>>>2&7)+4,c=e[i]+(o>>>5<<8),i++;break;case 2:if(n<=i+1)throw new Error("snappy error end of input");s=(o>>>2)+1,c=e[i]+(e[i+1]<<8),i+=2;break;case 3:if(n<=i+3)throw new Error("snappy error end of input");s=(o>>>2)+1,c=e[i]+(e[i+1]<<8)+(e[i+2]<<16)+(e[i+3]<<24),i+=4;break}if(c===0||isNaN(c))throw new Error(`invalid offset ${c} pos ${i} inputLength ${n}`);if(c>r)throw new Error("cannot copy from before start of buffer");$(t,r-c,t,r,s),r+=s}}if(r!==f)throw new Error("premature end of input")}function Ye(e,t,{type:n,element:f,schemaPath:i}){const r=new DataView(e.buffer,e.byteOffset,e.byteLength),o={view:r,offset:0};let s;const c=ke(o,t,i),{definitionLevels:a,numNulls:l}=$e(o,t,i),u=t.num_values-l;if(t.encoding==="PLAIN")s=x(o,n,u,f.type_length);else if(t.encoding==="PLAIN_DICTIONARY"||t.encoding==="RLE_DICTIONARY"||t.encoding==="RLE"){const _=n==="BOOLEAN"?1:r.getUint8(o.offset++);_?(s=new Array(u),n==="BOOLEAN"?(E(o,_,s),s=s.map(g=>!!g)):E(o,_,s,r.byteLength-o.offset)):s=new Uint8Array(u)}else if(t.encoding==="BYTE_STREAM_SPLIT")s=oe(o,u,n,f.type_length);else if(t.encoding==="DELTA_BINARY_PACKED")s=n==="INT32"?new Int32Array(u):new BigInt64Array(u),L(o,u,s);else if(t.encoding==="DELTA_LENGTH_BYTE_ARRAY")s=new Array(u),re(o,u,s);else throw new Error(`parquet unsupported encoding: ${t.encoding}`);return{definitionLevels:a,repetitionLevels:c,dataPage:s}}function ke(e,t,n){if(n.length>1){const f=K(n);if(f){const i=new Array(t.num_values);return E(e,D(f),i),i}}return[]}function $e(e,t,n){const f=U(n);if(!f)return{definitionLevels:[],numNulls:0};const i=new Array(t.num_values);E(e,D(f),i);let r=t.num_values;for(const o of i)o===f&&r--;return r===0&&(i.length=0),{definitionLevels:i,numNulls:r}}function B(e,t,n,f){let i;const r=f?.[n];if(n==="UNCOMPRESSED")i=e;else if(r)i=r(e,t);else if(n==="SNAPPY")i=new Uint8Array(t),qe(e,i);else throw new Error(`parquet unsupported compression codec: ${n}`);if(i?.length!==t)throw new Error(`parquet decompressed page length ${i?.length} does not match header ${t}`);return i}function Ve(e,t,n){const i={view:new DataView(e.buffer,e.byteOffset,e.byteLength),offset:0},{type:r,element:o,schemaPath:s,codec:c,compressors:a}=n,l=t.data_page_header_v2;if(!l)throw new Error("parquet data page header v2 is undefined");const u=ze(i,l,s);i.offset=l.repetition_levels_byte_length;const _=je(i,l,s),g=t.uncompressed_page_size-l.definition_levels_byte_length-l.repetition_levels_byte_length;let w=e.subarray(i.offset);l.is_compressed!==!1&&(w=B(w,g,c,a));const p=new DataView(w.buffer,w.byteOffset,w.byteLength),y={view:p,offset:0};let d;const h=l.num_values-l.num_nulls;if(l.encoding==="PLAIN")d=x(y,r,h,o.type_length);else if(l.encoding==="RLE")d=new Array(h),E(y,1,d),d=d.map(A=>!!A);else if(l.encoding==="PLAIN_DICTIONARY"||l.encoding==="RLE_DICTIONARY"){const A=p.getUint8(y.offset++);d=new Array(h),E(y,A,d,g-1)}else if(l.encoding==="DELTA_BINARY_PACKED")d=r==="INT32"?new Int32Array(h):new BigInt64Array(h),L(y,h,d);else if(l.encoding==="DELTA_LENGTH_BYTE_ARRAY")d=new Array(h),re(y,h,d);else if(l.encoding==="DELTA_BYTE_ARRAY")d=new Array(h),Le(y,h,d);else if(l.encoding==="BYTE_STREAM_SPLIT")d=oe(i,h,r,o.type_length);else throw new Error(`parquet unsupported encoding: ${l.encoding}`);return{definitionLevels:_,repetitionLevels:u,dataPage:d}}function ze(e,t,n){const f=K(n);if(!f)return[];const i=new Array(t.num_values);return E(e,D(f),i,t.repetition_levels_byte_length),i}function je(e,t,n){const f=U(n);if(f){const i=new Array(t.num_values);return E(e,D(f),i,t.definition_levels_byte_length),i}}function Ge(e,{groupStart:t,selectStart:n,selectEnd:f},i,r){const{columnName:o}=i,s=[];let c,a,l=0;const u=r&&(()=>{a&&r({columnName:o,columnData:a,rowStart:t+l-a.length,rowEnd:t+l})});for(;l<f&&!(e.offset>=e.view.byteLength-1);){const _=We(e);if(_.type==="DICTIONARY_PAGE")c=V(e,_,i,c,void 0,0),c=G(c,i);else{const g=a?.length||0,w=V(e,_,i,c,a,n-l);a===w?l+=w.length-g:(u?.(),s.push(w),l+=w.length,a=w)}}return u?.(),l>f&&a&&(s[s.length-1]=a.slice(0,f-(l-a.length))),s}function V(e,t,n,f,i,r){const{type:o,element:s,schemaPath:c,codec:a,compressors:l}=n,u=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,t.compressed_page_size);if(e.offset+=t.compressed_page_size,t.type==="DATA_PAGE"){const _=t.data_page_header;if(!_)throw new Error("parquet data page header is undefined");if(r>_.num_values&&de(c))return new Array(_.num_values);const g=B(u,Number(t.uncompressed_page_size),a,l),{definitionLevels:w,repetitionLevels:p,dataPage:y}=Ye(g,_,n);let d=C(y,f,_.encoding,n);if(p.length||w?.length){const h=Array.isArray(i)?i:[];return k(h,w,p,d,c)}else{for(let h=2;h<c.length;h++)c[h].element.repetition_type!=="REQUIRED"&&(d=Array.from(d,A=>[A]));return d}}else if(t.type==="DATA_PAGE_V2"){const _=t.data_page_header_v2;if(!_)throw new Error("parquet data page header v2 is undefined");if(r>_.num_rows)return new Array(_.num_values);const{definitionLevels:g,repetitionLevels:w,dataPage:p}=Ve(u,t,n),y=C(p,f,_.encoding,n),d=Array.isArray(i)?i:[];return k(d,g,w,y,c)}else if(t.type==="DICTIONARY_PAGE"){const _=t.dictionary_page_header;if(!_)throw new Error("parquet dictionary page header is undefined");const g=B(u,Number(t.uncompressed_page_size),a,l),w={view:new DataView(g.buffer,g.byteOffset,g.byteLength),offset:0};return x(w,o,_.num_values,s.type_length)}else throw new Error(`parquet unsupported page type: ${t.type}`)}function We(e){const t=X(e),n=z[t.field_1],f=t.field_2,i=t.field_3,r=t.field_4,o=t.field_5&&{num_values:t.field_5.field_1,encoding:T[t.field_5.field_2],definition_level_encoding:T[t.field_5.field_3],repetition_level_encoding:T[t.field_5.field_4],statistics:t.field_5.field_5&&{max:t.field_5.field_5.field_1,min:t.field_5.field_5.field_2,null_count:t.field_5.field_5.field_3,distinct_count:t.field_5.field_5.field_4,max_value:t.field_5.field_5.field_5,min_value:t.field_5.field_5.field_6}},s=t.field_6,c=t.field_7&&{num_values:t.field_7.field_1,encoding:T[t.field_7.field_2],is_sorted:t.field_7.field_3},a=t.field_8&&{num_values:t.field_8.field_1,num_nulls:t.field_8.field_2,num_rows:t.field_8.field_3,encoding:T[t.field_8.field_4],definition_levels_byte_length:t.field_8.field_5,repetition_levels_byte_length:t.field_8.field_6,is_compressed:t.field_8.field_7===void 0?!0:t.field_8.field_7,statistics:t.field_8.field_8};return{type:n,uncompressed_page_size:f,compressed_page_size:i,crc:r,data_page_header:o,index_page_header:s,dictionary_page_header:c,data_page_header_v2:a}}function Ze(e,{metadata:t,columns:n},f){const{file:i,compressors:r,utf8:o}=e,s=[],c={...j,...e.parsers};for(const{file_path:a,meta_data:l}of f.rowGroup.columns){if(a)throw new Error("parquet file_path not supported");if(!l)throw new Error("parquet column metadata is undefined");const u=l.path_in_schema[0];if(n&&!n.includes(u))continue;const{startByte:_,endByte:g}=ne(l),w=g-_;if(w>1<<30){console.warn(`parquet skipping huge column "${l.path_in_schema}" ${w} bytes`);continue}const p=Promise.resolve(i.slice(_,g));s.push({pathInSchema:l.path_in_schema,data:p.then(y=>{const d=H(t.schema,l.path_in_schema),h={view:new DataView(y),offset:0},I={columnName:l.path_in_schema.join("."),type:l.type,element:d[d.length-1].element,schemaPath:d,codec:l.codec,parsers:c,compressors:r,utf8:o};return Ge(h,f,I,e.onPage)})})}return{groupStart:f.groupStart,groupRows:f.groupRows,asyncColumns:s}}async function Qe({asyncColumns:e},t,n,f,i){const r=new Array(n),o=await Promise.all(e.map(({data:l})=>l.then(te))),s=e.map(l=>l.pathInSchema[0]).filter(l=>!f||f.includes(l)),c=f??s,a=c.map(l=>e.findIndex(u=>u.pathInSchema[0]===l));for(let l=t;l<n;l++)if(i==="object"){const u={};for(let _=0;_<e.length;_++)u[e[_].pathInSchema[0]]=o[_][l];r[l]=u}else{const u=new Array(e.length);for(let _=0;_<c.length;_++)a[_]>=0&&(u[_]=o[a[_]][l]);r[l]=u}return r}function He(e,t){const{asyncColumns:n}=e,f=[];for(const i of t.children)if(i.children.length){const r=n.filter(c=>c.pathInSchema[0]===i.element.name);if(!r.length)continue;const o=new Map,s=Promise.all(r.map(c=>c.data.then(a=>{o.set(c.pathInSchema.join("."),te(a))}))).then(()=>{b(o,i);const c=o.get(i.path.join("."));if(!c)throw new Error("parquet column data not assembled");return[c]});f.push({pathInSchema:i.path,data:s})}else{const r=n.find(o=>o.pathInSchema[0]===i.element.name);r&&f.push(r)}return{...e,asyncColumns:f}}async function Ke(e){e.metadata??=await ye(e.file);const t=await Xe(e),{rowStart:n=0,rowEnd:f,columns:i,onChunk:r,onComplete:o,rowFormat:s}=e;if(!o&&!r){for(const{asyncColumns:l}of t)for(const{data:u}of l)await u;return}const c=me(e.metadata),a=t.map(l=>He(l,c));if(r)for(const l of a)for(const u of l.asyncColumns)u.data.then(_=>{let g=l.groupStart;for(const w of _)r({columnName:u.pathInSchema[0],columnData:w,rowStart:g,rowEnd:g+w.length}),g+=w.length});if(o){const l=[];for(const u of a){const _=Math.max(n-u.groupStart,0),g=Math.min((f??1/0)-u.groupStart,u.groupRows),w=await Qe(u,_,g,i,s);M(l,w.slice(_,g))}o(l)}else for(const{asyncColumns:l}of a)for(const{data:u}of l)await u}function Xe(e){if(!e.metadata)throw new Error("parquet requires metadata");const t=ve(e);return e.file=be(e.file,t),t.groups.map(n=>Ze(e,t,n))}function et(e){return new Promise((t,n)=>{Ke({rowFormat:"object",...e,onComplete:t}).catch(n)})}export{Je as a,et as p};
